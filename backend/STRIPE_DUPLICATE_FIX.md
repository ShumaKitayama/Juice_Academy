# Stripe é‡è¤‡é¡§å®¢å•é¡Œã®ä¿®æ­£

## ğŸ“‹ å•é¡Œã®æ¦‚è¦

åŒã˜ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§è¤‡æ•°ã® Stripe é¡§å®¢ãŒä½œæˆã•ã‚Œã¦ã—ã¾ã†å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚

### åŸå› 

1. **MongoDB ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯**: `CreateStripeCustomerHandler` ãŒ MongoDB ã® `payments` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ã‚’ç¢ºèªã—ã¦ã„ãŸ
2. **Stripe å´ã®ãƒã‚§ãƒƒã‚¯ä¸è¶³**: Stripe ã«æ—¢å­˜é¡§å®¢ãŒã‚ã£ã¦ã‚‚æ¤œå‡ºã§ããªã‹ã£ãŸ
3. **ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®æœªæ´»ç”¨**: æ—¢å­˜é¡§å®¢ã® `user_id` ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ã„ãªã‹ã£ãŸ

## ğŸ”§ ä¿®æ­£å†…å®¹

### 1. é¡§å®¢ä½œæˆãƒ­ã‚¸ãƒƒã‚¯ã®æ”¹å–„ (`backend/controllers/payment.go`)

#### ä¿®æ­£å‰ã®å•é¡Œç‚¹

```go
// MongoDB ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
err = paymentCollection.FindOne(ctx, bson.M{"user_id": userID}).Decode(&existingPayment)
if err == nil {
    // æ—¢ã«å­˜åœ¨ã™ã‚‹ â†’ çµ‚äº†
    return
}

// Stripe ã«ç›´æ¥æ–°è¦é¡§å®¢ã‚’ä½œæˆï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ãªã—ï¼‰
stripeCustomer, err := customer.New(params)
```

**å•é¡Œ**:

- MongoDB ã«è¨˜éŒ²ãŒãªã‘ã‚Œã°ã€Stripe ã«æ—¢å­˜é¡§å®¢ãŒã‚ã£ã¦ã‚‚æ–°è¦ä½œæˆã—ã¦ã—ã¾ã†
- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ â†’ å†ç™»éŒ²ã®ã‚±ãƒ¼ã‚¹ã§é‡è¤‡ãŒç™ºç”Ÿ

#### ä¿®æ­£å¾Œã®å®‰å…¨ãªãƒ­ã‚¸ãƒƒã‚¯

```go
// 1. MongoDB ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¢å­˜ï¼‰
// 2. Stripe ã§æ—¢å­˜é¡§å®¢ã‚’æ¤œç´¢ï¼ˆæ–°è¦è¿½åŠ ï¼‰
customerListParams := &stripe.CustomerListParams{}
customerListParams.Email = stripe.String(user.Email)
customerListParams.Limit = stripe.Int64(10)

customerIter := customer.List(customerListParams)
foundValidCustomer := false

// 3. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã® user_id ã§æ­£ã—ã„é¡§å®¢ã‚’ç‰¹å®š
for customerIter.Next() {
    existingCustomer := customerIter.Customer()

    if metaUserID, exists := existingCustomer.Metadata["user_id"]; exists {
        if metaUserID == userID.Hex() {
            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç´ã¥ã„ã¦ã„ã‚‹é¡§å®¢ã‚’å†åˆ©ç”¨
            stripeCustomer = existingCustomer
            foundValidCustomer = true
            break
        }
    }
}

// 4. è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ã¿æ–°è¦ä½œæˆ
if !foundValidCustomer {
    // Idempotency key ã§åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¯¾ç­–
    idempotencyKey := "customer-create:" + userID.Hex()
    params.SetIdempotencyKey(idempotencyKey)

    stripeCustomer, err = customer.New(params)
}
```

**æ”¹å–„ç‚¹**:
âœ… **ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã§æ­£ç¢ºã«ç‰¹å®š**: åŒã˜ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã‚‚ `user_id` ãŒä¸€è‡´ã™ã‚‹é¡§å®¢ã®ã¿ã‚’å†åˆ©ç”¨  
âœ… **ä»–äººã®é¡§å®¢ã‚’ä½¿ç”¨ã™ã‚‹ãƒªã‚¹ã‚¯æ’é™¤**: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ â†’ å†ç™»éŒ²ã§ã‚‚å®‰å…¨  
âœ… **åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¯¾ç­–**: Idempotency key ã§é‡è¤‡ä½œæˆã‚’é˜²æ­¢  
âœ… **è©³ç´°ãªãƒ­ã‚°**: ã©ã®é¡§å®¢ã‚’ä½¿ç”¨ã—ãŸã‹ã€ãªãœæ–°è¦ä½œæˆã—ãŸã‹ã‚’è¨˜éŒ²

### 2. é‡è¤‡æ¤œå‡ºã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ”¹å–„ (`backend/scripts/detect_stripe_duplicates.go`)

#### ä¸»ãªæ”¹å–„ç‚¹

##### (1) ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®å»¶é•·

```go
// ä¿®æ­£å‰: 30ç§’ï¼ˆé¡§å®¢ãŒå¤šã„å ´åˆã«ä¸è¶³ï¼‰
ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)

// ä¿®æ­£å¾Œ: 5åˆ†ï¼ˆå…¨é¡§å®¢å–å¾—ã«å¯¾å¿œï¼‰
ctx, cancel := context.WithTimeout(context.Background(), 5*time.Minute)
```

##### (2) å®‰å…¨ãªå‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³

```go
// ä¿®æ­£å‰: panic ã®ãƒªã‚¹ã‚¯
userID := user["_id"].(primitive.ObjectID)
stripeCustomerID := payment["stripe_customer_id"].(string)

// ä¿®æ­£å¾Œ: å®‰å…¨ãªãƒã‚§ãƒƒã‚¯
userID, ok := user["_id"].(primitive.ObjectID)
if !ok {
    fmt.Printf("âš  ã‚¨ãƒ©ãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å‹å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ\n")
    return
}
```

##### (3) ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°è¡¨ç¤º

```go
// ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
if userID, exists := c.Metadata["user_id"]; exists {
    fmt.Printf("      ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ user_id: %s\n", userID)
} else {
    fmt.Printf("      ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ user_id: (æœªè¨­å®š)\n")
}
```

##### (4) ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–

```go
// Stripe API ã®ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
if pmList.Err() != nil {
    fmt.Printf("      ç™»éŒ²æ¸ˆã¿æ”¯æ‰•ã„æ–¹æ³•: ã‚¨ãƒ©ãƒ¼ (%v)\n", pmList.Err())
}

if customerIter.Err() != nil {
    log.Printf("\nè­¦å‘Š: Stripeé¡§å®¢ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: %v", customerIter.Err())
}
```

##### (5) ã‚ˆã‚Šå®Ÿç”¨çš„ãªæ¨å¥¨äº‹é …

```
æ¨å¥¨äº‹é …:
  1. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®user_idãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹é¡§å®¢ã‚’ä¿æŒ
  2. user_idãŒæœªè¨­å®šã¾ãŸã¯å¤ã„é¡§å®¢ã¯å‰Šé™¤å¯¾è±¡
  3. æ”¯æ‰•ã„æ–¹æ³•ã‚„ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã¯ã€ä¿æŒã™ã‚‹é¡§å®¢ã«ç§»è¡Œã—ã¦ã‹ã‚‰å‰Šé™¤
  4. MongoDBã®paymentsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹é¡§å®¢IDã‚’ç¢ºèª
  5. å‰Šé™¤ã¯Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¾ãŸã¯Stripe CLIã‹ã‚‰å®Ÿè¡Œ
     ä¾‹: stripe customers delete <customer_id>
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. é‡è¤‡é¡§å®¢ã®æ¤œå‡ºã¨åˆ†æ

#### æ–¹æ³• 1: ç’°å¢ƒå¤‰æ•°ã‚’ç›´æ¥æŒ‡å®šï¼ˆæ¨å¥¨ï¼‰

```bash
cd backend/scripts/detect_duplicates

# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦å®Ÿè¡Œ
MONGODB_URI="mongodb://localhost:27017/juice_academy" \
STRIPE_SECRET_KEY="sk_test_..." \
go run main.go
```

#### æ–¹æ³• 2: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã®.env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯è‡ªå‹•çš„ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆï¼ˆ`../../../.env`ï¼‰ã®`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã—ã¾ã™ã€‚

```bash
cd backend/scripts/detect_duplicates

# .envãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ã‚ã‚‹å ´åˆã€ç’°å¢ƒå¤‰æ•°ã®æŒ‡å®šã¯ä¸è¦
go run main.go
```

**æ³¨æ„**: `.env`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã¾ã™ãŒã€ç’°å¢ƒå¤‰æ•°ãŒç›´æ¥è¨­å®šã•ã‚Œã¦ã„ã‚Œã°å‹•ä½œã—ã¾ã™ã€‚

**å‡ºåŠ›ä¾‹**:

```
=== Stripeé‡è¤‡é¡§å®¢æ¤œå‡ºã‚¹ã‚¯ãƒªãƒ—ãƒˆ ===
âœ“ MongoDBæ¥ç¶šæˆåŠŸ

--- Stripeé¡§å®¢ã®å–å¾—ã¨åˆ†æ ---
  å‡¦ç†å®Œäº†: åˆè¨ˆ 150ä»¶ã®é¡§å®¢ã‚’ç¢ºèªã—ã¾ã—ãŸ

âš  é‡è¤‡é¡§å®¢ãŒ 1 ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ

--- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: 1216490@st.anan-nct.ac.jp ---
é¡§å®¢æ•°: 2
âœ“ MongoDBãƒ¦ãƒ¼ã‚¶ãƒ¼ID: 673849abc123def456789012
âœ“ MongoDBã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹Stripeé¡§å®¢ID: cus_R1234567890abc
âœ“ æ­£ã—ã„é¡§å®¢ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®user_idãŒä¸€è‡´ï¼‰: cus_R1234567890abc

é‡è¤‡é¡§å®¢ã®è©³ç´°:

  [1] é¡§å®¢ID: cus_R1234567890abc
      ä½œæˆæ—¥: 2024-11-17 05:09:00
      åå‰: ã‚­ã‚¿ãƒ¤ãƒã‚·ãƒ¥ã‚¦ãƒ
      ãƒ¡ãƒ¼ãƒ«: 1216490@st.anan-nct.ac.jp
      ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ user_id: 673849abc123def456789012
      ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ student_id: 1216490
      ç™»éŒ²æ¸ˆã¿æ”¯æ‰•ã„æ–¹æ³•: 1ä»¶
      ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³: 0ä»¶ (ã‚¢ã‚¯ãƒ†ã‚£ãƒ–: 0ä»¶)

  [2] é¡§å®¢ID: cus_Q0987654321xyz
      ä½œæˆæ—¥: 2024-11-17 04:30:00
      åå‰: ã‚­ã‚¿ãƒ¤ãƒã‚·ãƒ¥ã‚¦ãƒ
      ãƒ¡ãƒ¼ãƒ«: 1216490@st.anan-nct.ac.jp
      ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ user_id: (æœªè¨­å®š)
      ç™»éŒ²æ¸ˆã¿æ”¯æ‰•ã„æ–¹æ³•: 0ä»¶
      ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³: 0ä»¶ (ã‚¢ã‚¯ãƒ†ã‚£ãƒ–: 0ä»¶)

æ¨å¥¨äº‹é …:
  1. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®user_idãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹é¡§å®¢ã‚’ä¿æŒ
  2. user_idãŒæœªè¨­å®šã¾ãŸã¯å¤ã„é¡§å®¢ã¯å‰Šé™¤å¯¾è±¡
  ...
```

### 2. é‡è¤‡é¡§å®¢ã®å‰Šé™¤ï¼ˆæ‰‹å‹•ï¼‰

#### Stripe ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰å‰Šé™¤

1. [Stripe Dashboard - Customers](https://dashboard.stripe.com/customers) ã«ã‚¢ã‚¯ã‚»ã‚¹
2. å‰Šé™¤å¯¾è±¡ã®é¡§å®¢ ID ã§æ¤œç´¢
3. é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸ã§ã€ŒDelete customerã€ã‚’ã‚¯ãƒªãƒƒã‚¯

#### Stripe CLI ã‹ã‚‰å‰Šé™¤

```bash
# å‰Šé™¤å¯¾è±¡ã®é¡§å®¢ã‚’å‰Šé™¤
stripe customers delete cus_Q0987654321xyz
```

### 3. ä¿®æ­£ç‰ˆã‚³ãƒ¼ãƒ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ç§»å‹•ã—ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’å†èµ·å‹•
cd /path/to/Juice_Academy  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ç§»å‹•
docker-compose down
docker-compose up --build -d

# ãƒ­ã‚°ã‚’ç¢ºèª
docker-compose logs -f backend
```

## âœ… å‹•ä½œç¢ºèª

### 1. æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²

```bash
# æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé‡è¤‡ãªãä½œæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
curl -X POST http://localhost:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "Test1234",
    "student_id": "1234567",
    "name_kana": "ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼",
    "role": "student"
  }'

# Stripeé¡§å®¢ãŒä½œæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
curl -X POST http://localhost:8080/api/payment/customer \
  -H "Authorization: Bearer <jwt_token>"
```

### 2. æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¢ºèª

```bash
# 2å›ç›®ã®å‘¼ã³å‡ºã—ã§æ—¢å­˜é¡§å®¢ã‚’å†åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
curl -X POST http://localhost:8080/api/payment/customer \
  -H "Authorization: Bearer <jwt_token>"

# ãƒ­ã‚°ã§ "Found existing Stripe customer" ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
docker-compose logs backend | grep "Found existing"
```

### 3. ãƒ­ã‚°ã®ç¢ºèª

```bash
# é¡§å®¢ä½œæˆã®ãƒ­ã‚°ã‚’ç¢ºèª
docker-compose logs backend | grep "CreateStripeCustomer"

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
# - "Found existing Stripe customer: cus_xxx for user: xxx" (å†åˆ©ç”¨ã®å ´åˆ)
# - "Created new Stripe customer: cus_xxx for email: xxx" (æ–°è¦ä½œæˆã®å ´åˆ)
# - "Found customer xxx with same email but different user_id" (ç•°å¸¸ãªå ´åˆ)
```

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Q1: æ—¢å­˜ã®é‡è¤‡é¡§å®¢ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã¯?

**A**: `backend/scripts/detect_duplicates/main.go` ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§æ¤œå‡ºã—ã€æ‰‹å‹•ã§å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰ã¯æ–°ãŸãªé‡è¤‡ã‚’é˜²ãã¾ã™ã€‚

### Q4: `.env`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã¨ã„ã†è­¦å‘ŠãŒå‡ºã‚‹

**A**: ã“ã‚Œã¯è­¦å‘Šã®ã¿ã§ã€ç’°å¢ƒå¤‰æ•°ãŒç›´æ¥è¨­å®šã•ã‚Œã¦ã„ã‚Œã°å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã„ãŸã„å ´åˆã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆï¼ˆ`Juice_Academy/.env`ï¼‰ã«é…ç½®ã—ã¦ãã ã•ã„ã€‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯è‡ªå‹•çš„ã«æ¢ã—ã¾ã™ã€‚

### Q2: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã® user_id ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å¤ã„é¡§å®¢ãŒã‚ã‚‹

**A**: ä»¥ä¸‹ã®æ‰‹é †ã§å¯¾å¿œ:

1. MongoDB ã® `payments` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§æ­£ã—ã„é¡§å®¢ ID ã‚’ç¢ºèª
2. ãã®é¡§å®¢ã‚’ Stripe API ã§æ›´æ–°ã—ã¦ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
3. ä»–ã®é‡è¤‡é¡§å®¢ã‚’å‰Šé™¤

```bash
# Stripe CLIã§ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
stripe customers update cus_xxx \
  --metadata user_id=673849abc123def456789012
```

### Q3: åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§é‡è¤‡ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ã¯?

**A**: Idempotency key ã‚’è¨­å®šã—ã¦ã„ã‚‹ãŸã‚ã€åŒã˜ `user_id` ã§ã®è¤‡æ•°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯å®‰å…¨ã§ã™ã€‚Stripe ãŒè‡ªå‹•çš„ã«é‡è¤‡ã‚’é˜²ãã¾ã™ã€‚

## ğŸ“Š å½±éŸ¿ç¯„å›²

### ä¿®æ­£ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«

- âœ… `backend/controllers/payment.go` - é¡§å®¢ä½œæˆãƒ­ã‚¸ãƒƒã‚¯
- âœ… `backend/scripts/detect_stripe_duplicates.go` - é‡è¤‡æ¤œå‡ºã‚¹ã‚¯ãƒªãƒ—ãƒˆ

### å½±éŸ¿ã‚’å—ã‘ã‚‹ API

- `POST /api/payment/customer` - Stripe é¡§å®¢ä½œæˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®å½±éŸ¿

- ãªã—ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯å¤‰æ›´ã•ã‚Œã¾ã›ã‚“ï¼‰

### æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿

- ãªã—ï¼ˆæ—¢ã«æ­£ã—ãç´ã¥ã„ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯å½±éŸ¿ãªã—ï¼‰
- é‡è¤‡ãŒã‚ã‚‹å ´åˆã®ã¿ã€æ‰‹å‹•ã§ã®ä¿®æ­£ãŒå¿…è¦

## ğŸ¯ ä»Šå¾Œã®æ¨å¥¨äº‹é …

### 1. å®šæœŸçš„ãªãƒã‚§ãƒƒã‚¯

```bash
# æ¯æœˆ1å›ã€é‡è¤‡æ¤œå‡ºã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
0 0 1 * * cd /path/to/backend/scripts && ./run_duplicate_check.sh
```

### 2. ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

- Stripe ã®é¡§å®¢æ•°ã¨ MongoDB ã® `payments` ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã‚’å®šæœŸçš„ã«æ¯”è¼ƒ
- ä¹–é›¢ãŒã‚ã‚‹å ´åˆã¯èª¿æŸ»

### 3. ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

```go
// é‡è¤‡æ¤œå‡ºæ™‚ã«Slackãªã©ã«é€šçŸ¥ã‚’é€ä¿¡
if len(duplicateCustomers) > 0 {
    sendAlert("Stripe duplicate customers detected: " + len(duplicateCustomers))
}
```

### 4. è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆå°†æ¥çš„ï¼‰

- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ãªã„å¤ã„é¡§å®¢ã‚’è‡ªå‹•çš„ã«å‰Šé™¤
- ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚„æ”¯æ‰•ã„æ–¹æ³•ãŒãªã„é¡§å®¢ã®ã¿å¯¾è±¡

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Stripe API - Customers](https://stripe.com/docs/api/customers)
- [Stripe Idempotent Requests](https://stripe.com/docs/api/idempotent_requests)
- [MongoDB Unique Indexes](https://www.mongodb.com/docs/manual/core/index-unique/)

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ”¹å–„

1. **ä»–äººã®é¡§å®¢æƒ…å ±ã‚’ä½¿ç”¨ã™ã‚‹ãƒªã‚¹ã‚¯æ’é™¤**: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã® `user_id` ã§å³å¯†ã«ãƒã‚§ãƒƒã‚¯
2. **è©³ç´°ãªãƒ­ã‚°è¨˜éŒ²**: ä¸å¯©ãªå‹•ä½œï¼ˆuser_id ãŒä¸ä¸€è‡´ãªã©ï¼‰ã‚’æ¤œå‡º
3. **Idempotency key**: åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚„å†è©¦è¡Œã§ã®é‡è¤‡é˜²æ­¢

---

**ä½œæˆæ—¥**: 2024-11-17  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0  
**æ‹…å½“è€…**: AI Assistant
