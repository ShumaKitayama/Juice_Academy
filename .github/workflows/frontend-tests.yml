name: Frontend Tests

on:
  push:
    branches: [main, production-deployment]
    paths:
      - "frontend/**"
      - ".github/workflows/frontend-tests.yml"
  pull_request:
    branches: [main, production-deployment]
    paths:
      - "frontend/**"
      - ".github/workflows/frontend-tests.yml"

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run ESLint
        working-directory: ./frontend
        run: npm run lint

      - name: Type check
        working-directory: ./frontend
        run: npx tsc --noEmit

      - name: Build for production
        working-directory: ./frontend
        env:
          NODE_ENV: production
          VITE_API_URL: https://api.example.com/api
          VITE_STRIPE_PUBLISHABLE_KEY: pk_test_example
        run: npm run build

      - name: Test build artifacts
        working-directory: ./frontend
        run: |
          echo "ğŸ“¦ ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª..."
          ls -la dist/

          # ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ index.htmlãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          if [ ! -d "dist/assets" ]; then
            echo "âŒ assetsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          echo "âœ… ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèªå®Œäº†"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: frontend-build
          path: frontend/dist/
          retention-days: 7

      - name: Test summary
        if: always()
        run: |
          echo "ğŸ“‹ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†"
          echo "âœ… ESLinté™çš„è§£æ"
          echo "âœ… TypeScriptå‹ãƒã‚§ãƒƒã‚¯"
          echo "âœ… æœ¬ç•ªç’°å¢ƒãƒ“ãƒ«ãƒ‰"
          echo "âœ… ãƒ“ãƒ«ãƒ‰æˆæœç‰©ç¢ºèª"
