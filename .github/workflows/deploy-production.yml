name: Production Deployment

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "frontend/**"
      - "docker-compose.prod.yml"
      - "deploy.sh"
      - ".env.production"
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹"
        required: false
        default: false
        type: boolean

jobs:
  test:
    if: ${{ !inputs.skip_tests }}
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27018:27017
        env:
          MONGO_INITDB_DATABASE: juice_academy_test
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 30s

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install backend dependencies
        working-directory: ./backend
        run: go mod download

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run backend tests
        working-directory: ./backend
        env:
          MONGODB_TEST_URI: mongodb://localhost:27018
        run: |
          echo "ğŸ§ª ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          go test -v ./controllers ./middleware

      - name: Run frontend tests
        working-directory: ./frontend
        run: |
          echo "ğŸ§ª ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          npm run lint
          npx tsc --noEmit

      - name: Build frontend
        working-directory: ./frontend
        env:
          NODE_ENV: production
        run: npm run build

  deploy:
    needs: test
    if: ${{ always() && (needs.test.result == 'success' || inputs.skip_tests) }}
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build production images
        run: |
          echo "ğŸ”¨ æœ¬ç•ªç’°å¢ƒç”¨Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
          docker-compose -f docker-compose.prod.yml build --no-cache

      - name: Run deployment validation
        run: |
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ¤œè¨¼ã‚’å®Ÿè¡Œä¸­..."

          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ ! -f "docker-compose.prod.yml" ]; then
            echo "âŒ docker-compose.prod.yml ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          if [ ! -f "deploy.sh" ]; then
            echo "âŒ deploy.sh ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ç¢ºèª
          if ! docker images | grep -q "juice_academy"; then
            echo "âŒ æœ¬ç•ªç’°å¢ƒç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ¤œè¨¼å®Œäº†"

      - name: Deploy notification
        run: |
          echo "ğŸš€ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã®æº–å‚™å®Œäº†"
          echo "ğŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±ï¼š"
          echo "   - ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
          echo "   - ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
          echo "   - å®Ÿè¡Œè€…: ${{ github.actor }}"
          echo ""
          echo "âš ï¸  æ³¨æ„: å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯æ‰‹å‹•ã§å®Ÿè¡Œã—ã¦ãã ã•ã„"
          echo "   1. æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã«SSHæ¥ç¶š"
          echo "   2. ãƒªãƒã‚¸ãƒˆãƒªã‚’æœ€æ–°ã«æ›´æ–°"
          echo "   3. ./deploy.sh ã‚’å®Ÿè¡Œ"
