name: Backend Tests

on:
  push:
    branches: [main, production-deployment]
    paths:
      - "backend/**"
      - ".github/workflows/backend-tests.yml"
  pull_request:
    branches: [main, production-deployment]
    paths:
      - "backend/**"
      - ".github/workflows/backend-tests.yml"

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27018:27017
        env:
          MONGO_INITDB_DATABASE: juice_academy_test
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.adminCommand(\"ping\").ok' | grep -q 1"
          --health-interval 10s
          --health-timeout 10s
          --health-retries 10
          --health-start-period 60s

      redis:
        image: redis:alpine
        ports:
          - 6380:6379
        options: >-
          --health-cmd "redis-cli ping | grep -q PONG"
          --health-interval 10s
          --health-timeout 10s
          --health-retries 10
          --health-start-period 30s

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('backend/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        working-directory: ./backend
        run: go mod download

      - name: Verify dependencies
        working-directory: ./backend
        run: go mod verify

      - name: Run basic tests
        working-directory: ./backend
        env:
          JWT_SECRET: "test_jwt_secret_for_github_actions"
          APP_ENV: "test"
          REDIS_ADDR: "localhost:6380"
        run: |
          echo "ğŸ§ª åŸºæœ¬ãƒ†ã‚¹ãƒˆï¼ˆMongoDBä¸è¦ï¼‰ã‚’å®Ÿè¡Œä¸­..."
          go test -v ./controllers -run "TestRegister|TestLogin|TestGet.*Handler"
          go test -v ./controllers -run "TestBasic.*OTP.*Handler"
          go test -v ./middleware

      - name: Install MongoDB tools
        run: |
          echo "ğŸ“¦ MongoDB CLIãƒ„ãƒ¼ãƒ«ï¼ˆmongoshï¼‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          # MongoDBå…¬å¼ãƒªãƒã‚¸ãƒˆãƒªã‚’è¿½åŠ 
          curl -fsSL https://pgp.mongodb.com/server-7.0.asc | sudo gpg -o /usr/share/keyrings/mongodb-server-7.0.gpg --dearmor
          echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list

          # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¦mongoshã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          sudo apt-get update
          sudo apt-get install -y mongodb-mongosh

          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
          mongosh --version
          echo "âœ… mongoshã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"

      - name: Install Redis tools
        run: |
          echo "ğŸ“¦ Redis CLIãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          sudo apt-get update
          sudo apt-get install -y redis-tools netcat-openbsd

          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
          redis-cli --version
          nc -h 2>&1 | head -1 || echo "netcat-openbsd installed"
          echo "âœ… redis-cliã¨netcat-openbsdã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"

      - name: Wait for MongoDB
        run: |
          echo "â³ MongoDBã®æº–å‚™å®Œäº†ã‚’å¾…æ©Ÿä¸­..."
          max_retries=60
          retry_count=0
          connected=false

          while [ $retry_count -lt $max_retries ]; do
            retry_count=$((retry_count + 1))
            echo "MongoDBæ¥ç¶šè©¦è¡Œ $retry_count/$max_retries..."
            
            # ã‚ˆã‚Šå …ç‰¢ãªæ¥ç¶šãƒã‚§ãƒƒã‚¯
            if mongosh --host localhost:27018 --quiet --eval "db.adminCommand('ping').ok" 2>/dev/null | grep -q "1"; then
              echo "âœ… MongoDBãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸ (è©¦è¡Œå›æ•°: $retry_count)"
              connected=true
              break
            fi
            
            if [ $retry_count -eq $max_retries ]; then
              echo "âŒ MongoDBã®æº–å‚™ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ ($((max_retries * 3))ç§’çµŒé)"
              echo "ğŸ” MongoDBæ¥ç¶šæƒ…å ±ã‚’ãƒ‡ãƒãƒƒã‚°ä¸­..."
              
              # ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ³ç¢ºèª
              echo "GitHub Actions Servicesã®çŠ¶æ³:"
              docker ps -a | head -10
              
              # ãƒãƒ¼ãƒˆæ¥ç¶šç¢ºèª
              echo "ãƒãƒ¼ãƒˆ27018ã®æ¥ç¶šç¢ºèª:"
              nc -z localhost 27018 && echo "ãƒãƒ¼ãƒˆ27018ã¯é–‹ã„ã¦ã„ã¾ã™" || echo "ãƒãƒ¼ãƒˆ27018ã«æ¥ç¶šã§ãã¾ã›ã‚“"
              
              # MongoDBæ¥ç¶šãƒ†ã‚¹ãƒˆ
              echo "MongoDBæ¥ç¶šãƒ†ã‚¹ãƒˆ:"
              mongosh --host localhost:27018 --eval "db.adminCommand('ping')" || echo "MongoDBæ¥ç¶šã«å¤±æ•—"
              
              exit 1
            fi
            
            sleep 3
          done

      - name: Wait for Redis
        run: |
          echo "â³ Redisã®æº–å‚™å®Œäº†ã‚’å¾…æ©Ÿä¸­..."
          max_retries=30
          retry_count=0

          while [ $retry_count -lt $max_retries ]; do
            retry_count=$((retry_count + 1))
            echo "Redisæ¥ç¶šè©¦è¡Œ $retry_count/$max_retries..."
            
            if redis-cli -h localhost -p 6380 ping | grep -q "PONG"; then
              echo "âœ… RedisãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸ (è©¦è¡Œå›æ•°: $retry_count)"
              break
            fi
            
            if [ $retry_count -eq $max_retries ]; then
              echo "âŒ Redisã®æº–å‚™ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"
              echo "ğŸ” Redisæ¥ç¶šæƒ…å ±ã‚’ãƒ‡ãƒãƒƒã‚°ä¸­..."
              
              # ãƒãƒ¼ãƒˆæ¥ç¶šç¢ºèª
              echo "ãƒãƒ¼ãƒˆ6380ã®æ¥ç¶šç¢ºèª:"
              nc -z localhost 6380 && echo "ãƒãƒ¼ãƒˆ6380ã¯é–‹ã„ã¦ã„ã¾ã™" || echo "ãƒãƒ¼ãƒˆ6380ã«æ¥ç¶šã§ãã¾ã›ã‚“"
              
              # Redisæ¥ç¶šãƒ†ã‚¹ãƒˆ
              echo "Redisæ¥ç¶šãƒ†ã‚¹ãƒˆ:"
              redis-cli -h localhost -p 6380 ping || echo "Redisæ¥ç¶šã«å¤±æ•—"
              
              exit 1
            fi
            
            sleep 2
          done

      - name: Run integration tests
        working-directory: ./backend
        env:
          MONGODB_TEST_URI: mongodb://localhost:27018
          JWT_SECRET: "test_jwt_secret_for_github_actions"
          APP_ENV: "test"
          REDIS_ADDR: "localhost:6380"
        run: |
          echo "ğŸ—„ï¸  MongoDBçµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          go test -v ./controllers -run "TestAuthIntegrationSuite|TestUserRegistrationIntegration|TestUserAuthenticationIntegration|TestAdminUserIntegration"
          go test -v ./controllers -run "TestAnnouncementIntegrationSuite|TestAnnouncementCRUDIntegration|TestAnnouncementListIntegration|TestAnnouncementQueryIntegration"

      - name: Run admin tests
        working-directory: ./backend
        env:
          MONGODB_TEST_URI: mongodb://localhost:27018
          JWT_SECRET: "test_jwt_secret_for_github_actions"
          APP_ENV: "test"
          REDIS_ADDR: "localhost:6380"
        run: |
          echo "ğŸ‘‘ ç®¡ç†è€…æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          go test -v ./controllers -run "TestAdmin.*" || echo "âš ï¸ ç®¡ç†è€…ãƒ†ã‚¹ãƒˆã§è­¦å‘Šï¼ˆç¶™ç¶šï¼‰"

      - name: Generate test coverage
        working-directory: ./backend
        env:
          MONGODB_TEST_URI: mongodb://localhost:27018
          JWT_SECRET: "test_jwt_secret_for_github_actions"
          APP_ENV: "test"
          REDIS_ADDR: "localhost:6380"
        run: |
          echo "ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç”Ÿæˆä¸­..."
          go test -v -coverprofile=coverage.out ./controllers ./middleware
          go tool cover -func=coverage.out

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./backend/coverage.out
          directory: ./backend
          fail_ci_if_error: false
          verbose: true

      - name: Test summary
        if: always()
        run: |
          echo "ğŸ“‹ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†"
          echo "âœ… åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆï¼ˆèªè¨¼ã€ãŠçŸ¥ã‚‰ã›ã€JWTã€2FAï¼‰"
          echo "âœ… MongoDBçµ±åˆãƒ†ã‚¹ãƒˆï¼ˆèªè¨¼ã€ãŠçŸ¥ã‚‰ã›ã®CRUDï¼‰"
          echo "âœ… Redisçµ±åˆãƒ†ã‚¹ãƒˆï¼ˆOTPé‡è¤‡é˜²æ­¢ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰"
          echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã¨ã‚¯ã‚¨ãƒª"
          echo "âœ… ç®¡ç†è€…æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ"
          echo "âœ… 2æ®µéšèªè¨¼ï¼ˆOTPï¼‰æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ"
          echo "â±ï¸ æ”¹å–„ã•ã‚ŒãŸã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆMongoDB: 180ç§’, Redis: 60ç§’ï¼‰"
