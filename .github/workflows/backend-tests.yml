name: Backend Tests

on:
  push:
    branches: [main, production-deployment]
    paths:
      - "backend/**"
      - ".github/workflows/backend-tests.yml"
  pull_request:
    branches: [main, production-deployment]
    paths:
      - "backend/**"
      - ".github/workflows/backend-tests.yml"

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27018:27017
        env:
          MONGO_INITDB_DATABASE: juice_academy_test
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 30s

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('backend/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        working-directory: ./backend
        run: go mod download

      - name: Verify dependencies
        working-directory: ./backend
        run: go mod verify

      - name: Run basic tests
        working-directory: ./backend
        run: |
          echo "ğŸ§ª åŸºæœ¬ãƒ†ã‚¹ãƒˆï¼ˆMongoDBä¸è¦ï¼‰ã‚’å®Ÿè¡Œä¸­..."
          go test -v ./controllers -run "TestRegister|TestLogin|TestGet.*Handler"
          go test -v ./middleware

      - name: Wait for MongoDB
        run: |
          echo "â³ MongoDBã®æº–å‚™å®Œäº†ã‚’å¾…æ©Ÿä¸­..."
          for i in {1..30}; do
            if mongosh --host localhost:27018 --eval "db.adminCommand('ping')" > /dev/null 2>&1; then
              echo "âœ… MongoDBãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸ"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ MongoDBã®æº–å‚™ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"
              exit 1
            fi
            sleep 2
          done

      - name: Run integration tests
        working-directory: ./backend
        env:
          MONGODB_TEST_URI: mongodb://localhost:27018
        run: |
          echo "ğŸ—„ï¸  MongoDBçµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          go test -v ./controllers -run "TestAuthIntegrationSuite|TestUserRegistrationIntegration|TestUserAuthenticationIntegration|TestAdminUserIntegration"
          go test -v ./controllers -run "TestAnnouncementIntegrationSuite|TestAnnouncementCRUDIntegration|TestAnnouncementListIntegration|TestAnnouncementQueryIntegration"

      - name: Run admin tests
        working-directory: ./backend
        env:
          MONGODB_TEST_URI: mongodb://localhost:27018
        run: |
          echo "ğŸ‘‘ ç®¡ç†è€…æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          go test -v ./controllers -run "TestAdmin.*" || echo "âš ï¸ ç®¡ç†è€…ãƒ†ã‚¹ãƒˆã§è­¦å‘Šï¼ˆç¶™ç¶šï¼‰"

      - name: Generate test coverage
        working-directory: ./backend
        env:
          MONGODB_TEST_URI: mongodb://localhost:27018
        run: |
          echo "ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç”Ÿæˆä¸­..."
          go test -v -coverprofile=coverage.out ./controllers ./middleware
          go tool cover -func=coverage.out

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./backend/coverage.out
          directory: ./backend
          fail_ci_if_error: false
          verbose: true

      - name: Test summary
        if: always()
        run: |
          echo "ğŸ“‹ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†"
          echo "âœ… åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆï¼ˆèªè¨¼ã€ãŠçŸ¥ã‚‰ã›ã€JWTï¼‰"
          echo "âœ… MongoDBçµ±åˆãƒ†ã‚¹ãƒˆï¼ˆèªè¨¼ã€ãŠçŸ¥ã‚‰ã›ã®CRUDï¼‰"
          echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã¨ã‚¯ã‚¨ãƒª"
          echo "âœ… ç®¡ç†è€…æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ"
