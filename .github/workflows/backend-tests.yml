name: Backend Tests

on:
  push:
    branches: [main, production-deployment]
    paths:
      - "backend/**"
      - ".github/workflows/backend-tests.yml"
  pull_request:
    branches: [main, production-deployment]
    paths:
      - "backend/**"
      - ".github/workflows/backend-tests.yml"

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27018:27017
        env:
          MONGO_INITDB_DATABASE: juice_academy_test
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.adminCommand(\"ping\").ok' | grep -q 1"
          --health-interval 10s
          --health-timeout 10s
          --health-retries 10
          --health-start-period 60s

      redis:
        image: redis:alpine
        ports:
          - 6380:6379
        options: >-
          --health-cmd "redis-cli ping | grep -q PONG"
          --health-interval 10s
          --health-timeout 10s
          --health-retries 10
          --health-start-period 30s

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('backend/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        working-directory: ./backend
        run: go mod download

      - name: Verify dependencies
        working-directory: ./backend
        run: go mod verify

      - name: Run basic tests
        working-directory: ./backend
        env:
          JWT_SECRET: "test_jwt_secret_for_github_actions"
          APP_ENV: "test"
          REDIS_ADDR: "localhost:6380"
        run: |
          echo "ğŸ§ª åŸºæœ¬ãƒ†ã‚¹ãƒˆï¼ˆMongoDBä¸è¦ï¼‰ã‚’å®Ÿè¡Œä¸­..."
          go test -v ./controllers -run "TestRegister|TestLogin|TestGet.*Handler"
          go test -v ./controllers -run "TestBasic.*OTP.*Handler"
          go test -v ./middleware

      - name: Wait for MongoDB
        run: |
          echo "â³ MongoDBã®æº–å‚™å®Œäº†ã‚’å¾…æ©Ÿä¸­..."
          max_retries=60
          retry_count=0
          connected=false
          
          while [ $retry_count -lt $max_retries ]; do
            retry_count=$((retry_count + 1))
            echo "MongoDBæ¥ç¶šè©¦è¡Œ $retry_count/$max_retries..."
            
            # ã‚ˆã‚Šå …ç‰¢ãªæ¥ç¶šãƒã‚§ãƒƒã‚¯
            if mongosh --host localhost:27018 --quiet --eval "db.adminCommand('ping').ok" 2>/dev/null | grep -q "1"; then
              echo "âœ… MongoDBãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸ (è©¦è¡Œå›æ•°: $retry_count)"
              connected=true
              break
            fi
            
            if [ $retry_count -eq $max_retries ]; then
              echo "âŒ MongoDBã®æº–å‚™ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ ($((max_retries * 3))ç§’çµŒé)"
              echo "MongoDBæ¥ç¶šæƒ…å ±ã‚’ãƒ‡ãƒãƒƒã‚°ä¸­..."
              docker ps -a | grep mongo || echo "MongoDBã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              mongosh --host localhost:27018 --eval "db.adminCommand('ping')" || echo "MongoDBæ¥ç¶šã«å¤±æ•—"
              exit 1
            fi
            
            sleep 3
          done

      - name: Wait for Redis
        run: |
          echo "â³ Redisã®æº–å‚™å®Œäº†ã‚’å¾…æ©Ÿä¸­..."
          max_retries=30
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            retry_count=$((retry_count + 1))
            echo "Redisæ¥ç¶šè©¦è¡Œ $retry_count/$max_retries..."
            
            if redis-cli -h localhost -p 6380 ping | grep -q "PONG"; then
              echo "âœ… RedisãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸ (è©¦è¡Œå›æ•°: $retry_count)"
              break
            fi
            
            if [ $retry_count -eq $max_retries ]; then
              echo "âŒ Redisã®æº–å‚™ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"
              echo "Redisæ¥ç¶šæƒ…å ±ã‚’ãƒ‡ãƒãƒƒã‚°ä¸­..."
              redis-cli -h localhost -p 6380 ping || echo "Redisæ¥ç¶šã«å¤±æ•—"
              exit 1
            fi
            
            sleep 2
          done

      - name: Run integration tests
        working-directory: ./backend
        env:
          MONGODB_TEST_URI: mongodb://localhost:27018
          JWT_SECRET: "test_jwt_secret_for_github_actions"
          APP_ENV: "test"
          REDIS_ADDR: "localhost:6380"
        run: |
          echo "ğŸ—„ï¸  MongoDBçµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          go test -v ./controllers -run "TestAuthIntegrationSuite|TestUserRegistrationIntegration|TestUserAuthenticationIntegration|TestAdminUserIntegration"
          go test -v ./controllers -run "TestAnnouncementIntegrationSuite|TestAnnouncementCRUDIntegration|TestAnnouncementListIntegration|TestAnnouncementQueryIntegration"

      - name: Run admin tests
        working-directory: ./backend
        env:
          MONGODB_TEST_URI: mongodb://localhost:27018
          JWT_SECRET: "test_jwt_secret_for_github_actions"
          APP_ENV: "test"
          REDIS_ADDR: "localhost:6380"
        run: |
          echo "ğŸ‘‘ ç®¡ç†è€…æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          go test -v ./controllers -run "TestAdmin.*" || echo "âš ï¸ ç®¡ç†è€…ãƒ†ã‚¹ãƒˆã§è­¦å‘Šï¼ˆç¶™ç¶šï¼‰"

      - name: Generate test coverage
        working-directory: ./backend
        env:
          MONGODB_TEST_URI: mongodb://localhost:27018
          JWT_SECRET: "test_jwt_secret_for_github_actions"
          APP_ENV: "test"
          REDIS_ADDR: "localhost:6380"
        run: |
          echo "ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç”Ÿæˆä¸­..."
          go test -v -coverprofile=coverage.out ./controllers ./middleware
          go tool cover -func=coverage.out

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./backend/coverage.out
          directory: ./backend
          fail_ci_if_error: false
          verbose: true

      - name: Test summary
        if: always()
        run: |
          echo "ğŸ“‹ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†"
          echo "âœ… åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆï¼ˆèªè¨¼ã€ãŠçŸ¥ã‚‰ã›ã€JWTã€2FAï¼‰"
          echo "âœ… MongoDBçµ±åˆãƒ†ã‚¹ãƒˆï¼ˆèªè¨¼ã€ãŠçŸ¥ã‚‰ã›ã®CRUDï¼‰"
          echo "âœ… Redisçµ±åˆãƒ†ã‚¹ãƒˆï¼ˆOTPé‡è¤‡é˜²æ­¢ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰"
          echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã¨ã‚¯ã‚¨ãƒª"
          echo "âœ… ç®¡ç†è€…æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ"
          echo "âœ… 2æ®µéšèªè¨¼ï¼ˆOTPï¼‰æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ"
          echo "â±ï¸ æ”¹å–„ã•ã‚ŒãŸã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆMongoDB: 180ç§’, Redis: 60ç§’ï¼‰"
